# balionis-aws9

This sandbox is to remind me how to do terraform with docker and aws.

The source for below is https://learn.hashicorp.com/tutorials/terraform/install-cli 

## Install terraform

```
$ yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
$ yum -y install terraform
$ terraform -help plan
```

### Test terraform

```
$ firewall-cmd --zone=public --permanent --add-port=8000/tcp
$ firewall-cmd --reload
$ firewall-cmd --list-all

$ git clone https://github.com/balionis-arvydas/balionis-aws
$ cd ./balionis-aws/balionis-aws9/example1
$ touch example.tf 
// see contents
$ terraform init
$ terraform apply
$ curl -s -X GET http://banote17.balionis.com:8000/
$ terraform destroy
```

## Configure aws 

The source for below is https://learn.hashicorp.com/collections/terraform/aws-get-started

```
$ curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
$ unzip awscliv2.zip
$ ./aws/install
$ /usr/local/bin/aws --version
```

The below 'Administrator' access keys can be generated by https://console.aws.amazon.com/iam/home?region=eu-west-2#/users/Administrator?section=security_credentials 

```
$ /usr/local/bin/aws configure
AWS Access Key ID [None]: ######################
AWS Secret Access Key [None]: #################################
Default region name [None]: eu-west-2
Default output format [None]: json
```

## Test aws 

```
$ terraform init
$ terraform fmt
$ terraform validate
Success! The configuration is valid.
``` 

``` 
$ aws ec2 describe-images \
    --owners amazon \
    --filters 'Name=name,Values=amzn2-ami-hvm-2.0.????????.?-x86_64-gp2' 'Name=state,Values=available' \
    --query 'reverse(sort_by(Images, &CreationDate))[:1].ImageId' \
    --output text
$ vi example.tf 
  ami           = "ami-09b89ad3c5769cca2"
``` 

``` 
$ terraform apply
...
  Enter a value: yes

aws_instance.example: Creating...
aws_instance.example: Still creating... [10s elapsed]
aws_instance.example: Still creating... [20s elapsed]
aws_instance.example: Still creating... [30s elapsed]
aws_instance.example: Creation complete after 32s [id=i-0cb65ff4e6deac2c4]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
``` 

```
$ terraform show
...
# aws_instance.example:
resource "aws_instance" "example" {
    ami                          = "ami-09b89ad3c5769cca2"
    arn                          = "arn:aws:ec2:eu-west-2:613877803204:instance/i-0cb65ff4e6deac2c4"
    associate_public_ip_address  = true
    availability_zone            = "eu-west-2a"
    cpu_core_count               = 1
...
```

```
$ terraform destroy
aws_instance.example: Refreshing state... [id=i-0cb65ff4e6deac2c4]
...
Terraform will perform the following actions:

  # aws_instance.example will be destroyed
  - resource "aws_instance" "example" {
      - ami                          = "ami-09b89ad3c5769cca2" -> null
      - arn                          = "arn:aws:ec2:eu-west-2:613877803204:instance/i-0cb65ff4e6deac2c4" -> null
...
  Enter a value: yes

aws_instance.example: Destroying... [id=i-0cb65ff4e6deac2c4]
aws_instance.example: Still destroying... [id=i-0cb65ff4e6deac2c4, 10s elapsed]
aws_instance.example: Still destroying... [id=i-0cb65ff4e6deac2c4, 20s elapsed]
aws_instance.example: Destruction complete after 30s

Destroy complete! Resources: 1 destroyed.
```